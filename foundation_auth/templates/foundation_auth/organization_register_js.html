{% load i18n %}
<script>
    /**
     *  Function creates an Postal Address.
     */
    function api_postal_address(success_callback, error_callback) {
        var data = {
            'name': $('#id_name').val() + ' HQ Address',
            'address_country': $('#id_address_country').val(),
            'address_locality': $('#id_address_locality').val(),
            'address_region': $('#id_address_region').val(),
            'post_office_box_number': $('#id_post_office_box_number').val(),
            'postal_code': $('#id_postal_code').val(),
            'street_address': $('#id_street_address').val(),
            'owner': {{ request.user.id }},
        };

        if ( $('#id_hidden_postaladdress').val() ) {
            data['id'] = $('#id_hidden_postaladdress').val();
        }

        set_public_postaladdress(
            data,
            function(json_result) {
                success_callback(json_result); // Call back the function.
            },
            function(error_json_result) {
                error_callback(error_json_result); // Return JSON
            }
        ); // end Postal Address
    }

    /**
     *  Function creates an Organization.
     */
    function api_organization(success_callback, error_callback) {
        var data = {
            'schema_name': $('#id_schema_name').val(),
            'name': $('#id_name').val(),
            'alternate_name': $('#id_name').val(),
            'legal_name': $('#id_name').val(),
            'facebook_url': $('#id_facebook_url').val(),
            'twitter_url': $('#id_twitter_url').val(),
            'how_many_served': $('#id_how_many_served').val(),
            'is_tos_signed': $('#id_is_tos_signed').is(':checked'),
        };

        if ( $('#id_hidden_organization').val() ) {
            data['id'] = $('#id_hidden_organization').val();
        }

        if ( $('#id_hidden_postaladdress').val() ) {
            data['address'] = $('#id_hidden_postaladdress').val();
        }

        set_public_organization(data,
            data,
            function(org_json_result) {
                success_callback(org_json_result);
            },
            function(org_error_json_result) {
                error_callback(org_error_json_result); // Return JSON
            }
        ); // end Organization
    }

    var specialChars = "<>@!#$%^&*()_+[]{}?:;|'\"\\,./~`-=";
    var check = function(string){
        for(i = 0; i < specialChars.length;i++){
            if(string.indexOf(specialChars[i]) > -1){
                return true
            }
        }
        return false;
    };

    function ajax_save_org() {
        // Defensive Code: Protect against empty string.
        if( $('#id_schema_name').val() == "" ){
            alert("{% trans 'Missing Sub-Domain Name' %}");
            return;
        }
        // Defensive Code: Protect against illegal characters.
        if( check($('#id_schema_name').val()) == false){
            // Code that needs to execute when none of the above is in the string.
            // (Do nothing.)
        } else {
            alert("{% trans 'Your sub-domain string contains illegal characters.' %}");
            return;
        }

        // Defensive Code:
        if ( $('#id_how_many_served').val() == '' ) {
            alert("{% trans 'Please select how many entreprenuers are served' %}");
            return;
        }

        // Defensive Code: Ensure that the user agrees to the terms before proceeding.
        var is_tsa_checked = $('#id_is_tos_signed').is(':checked');
        if (is_tsa_checked == false) {
            alert("{% trans 'Please agree to the service agreement to continue.' %}");
            return;
        }

        /*
         *  Algorithm:
         *  1. Save the Postal Address.
         *  2. Save the Organization.
         *  3. Load the dashboard page.
         */
        api_postal_address(
            function(pa_success_result) {
                console.log("Successfully Created Postal Address");
                console.log(pa_success_result);
                $('#id_hidden_postaladdress').val(pa_success_result['id']);

                api_organization(
                    function(o_success_result) {
                        console.log("Successfully Created Organization");
                        console.log(o_success_result);
                        window.location = "{% url 'foundation_auth_org_successful_registration' %}";
                    },
                    function(o_error_result) {
                        console.log("BAD Organization");
                        console.log(o_error_result);
                    }
                ); // end Organization
            },
            function(pa_error_result) {
                console.log("BAD Postal Address");
                console.log(pa_error_result);
            }
        ); // end Postal Address
    }
</script>
